#!/bin/bash
#
# b3_tunnel
#
# description: creates an ssh tunnel to external systems running b3 services
# processname: b3_tunnel
# $Id: b3_tunnel,v 1.3 2008/09/19 15:34:22 jds Exp $
#

# Source function library.
. /etc/rc.d/init.d/functions

# Check that networking is up.
[ "$NETWORKING" = "no" ] && exit 0

prog=b3_tunnel
lockfile=/tmp/$prog
pidfile=/tmp/$prog-pid

rc_host=75.101.155.46
staging_host=75.101.153.178
live_host=75.101.155.138
port=11202

case "$2" in
	rc)
		host=$rc_host
		;;
	staging)
		host=$staging_host
		;;
	live)
		host=$live_host
		;;
	*)
		host=$rc_host
esac

start() {
	cmd="ssh -N -L$port:localhost:$port -o ServerAliveInterval=60 $host" 
 	echo $"Starting $cmd: "
	$($cmd) &
	pid=`ps ax | grep "$cmd" | grep -v grep | cut -d' ' -f1`
	retval=$?
	echo
	[ $retval -eq 0 ] && touch $lockfile
	echo $pid | cat > $pidfile
	return $retval
}

stop() {
	echo $"Stopping $prog: "
	kill `cat $pidfile`
	retval=$?
	echo
	[ $retval -eq 0 ] && rm -f $lockfile
	rm -f $pidfile
	return $retval
}

restart() {
	stop
	start
}

reload() {
	restart
}

force_reload() {
	restart
}

fdr_status() {
	status $prog
}


case "$1" in
	start|stop|restart|reload)
  		$1
		;;
	force-reload)
		force_reload
		;;
	status)
		fdr_status
		;;
	condrestart|try-restart)
		[ -f $lockfile ] || restart
		;;
	*)
		echo $"Usage: $0 {start|stop|status|restart|try-restart|reload|force-reload}"
		exit 1
esac

